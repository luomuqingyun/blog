---
title: STM32单片机编程之数据对齐
author: luomuqingyun
comments: true
category:
  - 编程
  - 单片机
tags:
  - 编程经验
  - STM32
excerpt:
  - STM32数据
categories: []
date: 2025-05-19 14:42:00
---
## 存储器的大小端
存储器的大小端储存方式是计算机系统中的两种不同的数据储存设置。与之相关的知识在学习单片机开发的过程也经常被提及，很多初学者可能经常为之困惑，想记住它但又可能记反。实际上这个知识点也用不着我们去死记硬背，其一是因为做基础的开发时不会涉及这些东西，其二是因为不管使用哪种模式单片机内核都已经给我们的程序做好了“预案”。这两种方式就像我们现在书写是从左上到右下，而古代书写是自右上到左下类似。所以初学者与其陷入这些概念困扰中不可自拔不如多去写点代码。那么等你真正需要用到这些知识届时你自然对它们会有自己的见解了。

当然，你若非要硬着头皮去记，那相关教材或网上很多前辈都有写过一大把介绍它的文章。我在这里推荐一种记忆方法做参考吧，原理就是按中文字面意思去理解，“端”在中文里就是端点，起点的意思，“小端”意思就是起点是储存“小数据值”的储存方法，反之，“大端”也就与之相对。现在你再结合图形示意看看这么解释对不对得上号：

![大小端储存示意](https://files.mdnice.com/user/38598/336d51f7-2b3f-4a97-ba55-dee86bd416a8.png)

这么理解起来应该是so easy 的吧，要是还不能理解那你自己敲脑袋去吧，我也只能告诉你小端是符合你平时的数字书写格式的那种。

STM32的芯片都是基于ARM Cortex-M系列的芯片，其内核都支持存储器大小端设置。默认为小端模式，当其复位时确定存储器模式之后在程序执行过程中是不可修改储存模式的，但是需要注意的两点是CPU取指令操作永远是小端模式；访问私有外设总是小端模式。此外，Cortex-M系列的大端模式与其他内核的大端模式稍有差异，但不用用户去处理，不影响编程。所以综上，对初学者的建议还是不用着急去处理这些内容，先有个基础概念即可。

写了这么多关于存储器端模式的内容，但本文的主要内容还是介绍单片机的数据对齐相关的知识。那么这两者之间有什么联系呢？实际上它们之间联系不是特别大，只是它们都是单片机存储器的主要内容，并且在你使用程序验证手头使用的单片机数据对齐特征时需要了解储存器特点以及大小端模式，所以在介绍之前先对大小端有一个大概的认知。

## 数据对齐
数据对齐(Data alignment)是计算机存储数据时采用的一种技术,它使数据的地址能够符合某种规则从而提高访问效率。

数据对齐的主要目的是优化内存访问速度。原因有两个:

- 许多CPU只能在某些地址处访问数据,如果数据没有对齐,CPU需要拆分多次读取,降低效率。

- 对齐可以减少内存碎片,提高内存利用率。未对齐的数据常常会造成内存空洞。

数据对齐常见的规则:

- 1字节对齐:数据地址可以是任意地址。

- 2字节对齐:数据地址必须是2的倍数。

- 4字节对齐:数据地址必须是4的倍数(32位CPU常用) 。

- 8字节对齐:数据地址必须是8的倍数(64位CPU常用)。

实现数据对齐的方法:

- 结构体内存对齐:加填充字节对齐结构体成员。

- 数组对齐:数组元素大小不确定时,统一设置为最大Size。

- 指针对齐:指针数据类型与指针大小对应。

- 编译器优化:编译器自动优化变量、参数对齐。

## 单片机数据传送
单片机芯片的数据传送控制方式是由内核决定的，而不是由生产厂商决定。TI或者ST依据Cortex-M3内核设计的一系列芯片其数据访问传送方式是一样的。

单片机领域常见的数据对齐访问方式有字对齐，半字对齐，以及字符对齐。所以单片机数据以字为单位的传送，其地址的最低两位必须是0；以半字为单位的传送，其地址的LSB必须是0；以字节为单位的传送则无所谓对不对齐，因为它们都是对齐的。

![对齐传送与非对齐传送](https://files.mdnice.com/user/38598/e784020b-3a9a-41c7-bd22-ef661eb49c4a.png)

有对齐访问就有非对齐访问，简单来说如果是字传送，那么对于所有不能被4整除的地址都是非对齐的，如果是半字传送，那么任何一个不能被2整除的地址都是非对齐的。

![非对齐字传送](https://files.mdnice.com/user/38598/d583eafa-6532-427b-80ef-621f80767448.png)

![非对齐半字传送](https://files.mdnice.com/user/38598/9fcc9b96-1c3e-46ba-8c2b-176b7f066dbf.png)


ARM cortex有很多的内核型号，不同内核内部设计一样，数据传送方式也会有所不同，比如M3内核在一定程度上支持非对齐数据访问，而M0内核只能对齐访问，所以当你将M3芯片的程序移植到M0芯片上时如果处理不当可能会发生错误，使得程序陷入Hard Fault。

当然并不是所有变量操作都会导致移植代码出现错误，一般普通的C语言程序移植到不支持非对齐访问的芯片上时并不会产生非对齐访问，因为编译器会帮我们将程序编译成当前芯片支持的二进制代码，而错误通常是我们的程序中使用了指针进行某些数据访问操作，这种情况就可能会造成非对齐访问错误（编译器是不会修改指针制定的访问地址的，这种情况相当于用户强制进行非对齐访问了）！所以在移植代码时需要妥善处理指针变量的数据对齐方式，当然更需要注意的就是结构体内部指针，数组这些相对隐蔽的指针变量。另外值得警惕的就是你程序中的汇编程序，因为汇编指令代码往往会直接操作底层内存地址，这正是C语言指针做的事情，很可能造成非对齐访问，如果处理不当就会出现错误！

## 如何避免数据对齐引发的问题
虽然移植程序可能出现的问题原因是各种各样的，因为数据对齐问题引发的错误也占有一定比例。在移植程序时出现这样的错误是每个开发者都不愿意看见的情景。

为了避免出现移植时数据传送不兼容而出错我们在编程时可以设置特定的对齐方式。方法就是使用`#pragma pack(n)`这个宏定义，n表示字节数，可以是1,2,4等等，申明此宏定义后其后的变量就会以定义的对齐方式进行储存。比如在定义结构体之前使用`#pragma pack(4)`声明，意味着将整个结构体变量以4字节的对齐方式储存。如果你只是想把某部分变量数据设置特定对齐方式这可以使用`#pragma pack(n)`和`#pragma pack()`将该段变量包裹来设置。当然`#pragma pack(n)`也需要合理使用，如果设置不当反而会造成程序数据访问错误。更多关于`#pragma pack()`的用法可以参考相关资料自行查阅，相关的知识还有`__packed`或`packed`，不同平台稍有差异。另外如果你想知道当前数据的对齐特点也可以通过定义变量或结构体来进行测试，具体步骤就不多讲解了，和测试大小端的方法类似，都是小儿科级别的操作了，不会的朋友可以百度。

其次在移植一些指针变量或指针函数时谨慎处理，确认其功能是否符合预期。

最后，这也是最容易忽视的地方，需要考虑编译器的差异以及优化等级设置，在刚移植时建议先减低优化等级。踩过坑的自然明白其中道理。

单片机的存储器功能是单片机的核心之一，在一般的应用程序中并不容易显现其重要性，但在涉及到实时系统或复杂应用操作时它的作用显而易见，对于初学者而言，并不一定开始就死磕各种细节，而是通过多练习基础功能，逐渐深入了解手头的单片机芯片，熟练之后遇到一些复杂问题时才更容易整合自己所能再结合一些资料解除疑惑。

----
>>>文章内容为作者个人观点，难免有疏忽或错误，若有不同见解可以交流评论，若发现错误还请指正，若认同文章观点，欢迎关注，分享。

>>>如学习需要或项目合作可以扫码添加微信。
建有交流群，以方便大家平时交流、学习，如果要进群，加好友时记得备注信息`进群`。
![](https://files.mdnice.com/user/38598/6fbcd253-edc6-4175-ba0c-44e24ad33b21.jpg)


占位

`温馨提示：若需要获取分享的资料，进入公众号后台发送关键字内容即可自动获取，而不是在留言或个人微信聊天界面发送！！！`

#### 推荐阅读
- [怎么快速上手一款新的MCU](https://mp.weixin.qq.com/s?__biz=MzI1OTQ4MTg4Ng==&mid=2247485581&idx=1&sn=b36e6536717774f7931c7aa93d5b237a&chksm=ea7900fcdd0e89ea0db13737720edc996fcb3fdbab3e43b4a92316240ac66d4b5a8bf9a07e78&token=466212876&lang=zh_CN#rd)
- [初学者看得懂代码却写不出怎么办](https://mp.weixin.qq.com/s?__biz=MzI1OTQ4MTg4Ng==&mid=2247485862&idx=1&sn=830ede5ac467c8d396adfbea141f0526&chksm=ea7901d7dd0e88c1e8e5396305ab83c6fbd884cf356ad64c54463230364e865a1659f193dd1f&token=63320980&lang=zh_CN#rd)
- [51单片机入门看这一篇就够了](https://mp.weixin.qq.com/s?__biz=MzI1OTQ4MTg4Ng==&mid=2247485523&idx=1&sn=b7fcd1b86e2467d6f03b1a520c39bb06&chksm=ea790022dd0e893452c4994fa16d63111b16d9878c303712f695b58b7af360b7b18c1ed4b201&token=1711068967&lang=zh_CN#rd)
- [实用单片机、电子开发小工具集](https://mp.weixin.qq.com/s?__biz=MzI1OTQ4MTg4Ng==&mid=2247485606&idx=1&sn=2b433faa2e436fc762dc538c9cf3fe14&chksm=ea7900d7dd0e89c169f8948ff3d423016c8f51f1c914eb7b0d20cba8145b9ffa54815915d67b&token=1580674001&lang=zh_CN#rd)
- [Keil软件如何高效格式化代码](https://mp.weixin.qq.com/s?__biz=MzI1OTQ4MTg4Ng==&mid=2247485572&idx=1&sn=17cefa35d9d660083d419a7e9b6db6f7&chksm=ea7900f5dd0e89e35b65ba26354cc69ad24f686d8e18abd34e0932567a9345e8c9ed653eee6b&token=1711068967&lang=zh_CN#rd)
- [两个电子开发初学者用得上的工具](https://mp.weixin.qq.com/s?__biz=MzI1OTQ4MTg4Ng==&mid=2247485987&idx=1&sn=106e52add61999ae4bddd8b28c7ed2b1&chksm=ea790252dd0e8b44e36e26f20153b1bd73a0fff98ef3c50330358435a9dfac2d97e04a30d59e&token=63320980&lang=zh_CN#rd)
- [windows平台上非常实用的小工具](https://mp.weixin.qq.com/s?__biz=MzI1OTQ4MTg4Ng==&mid=2247485420&idx=2&sn=728ca4abbadf7caf51c392e7d7045cbe&chksm=ea790f9ddd0e868b9fa162c80db1876199845f387bbe851c8d38a4e8412329ae635916c13cfb&token=1711068967&lang=zh_CN#rd)
- [51单片机入门学习推荐书单](https://mp.weixin.qq.com/s?__biz=MzI1OTQ4MTg4Ng==&mid=2247485689&idx=3&sn=d4c0d26781f307ffd26defdc4022c928&chksm=ea790088dd0e899e2872692b9568309e779acfc515e82c28a853d4228de2e2b8f7ee7149913f&token=63320980&lang=zh_CN#rd)
- [零基础电子技术知识集合](https://mp.weixin.qq.com/s?__biz=MzI1OTQ4MTg4Ng==&mid=2247485689&idx=4&sn=211c2d0871a19c5e92cdf0c34f01d96b&chksm=ea790088dd0e899e3042a649a346bc98e94189d1fd18da2b954a7ddb781582dc2d0a82e07f4d&token=970763775&lang=zh_CN#rd)
----
